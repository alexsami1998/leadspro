import{a as m}from"./chunk-IKNT5GKH.js";import{g as v}from"./chunk-STUYBPRI.js";import{O as b,T as u,a as p,b as L,d as s,j as A,q as i}from"./chunk-W5YSIOEO.js";var h=class n{constructor(e){this.databaseService=e}dispatchStatusChanged(e,t,a){return s(this,null,function*(){yield this.dispatchWebhooks("STATUS_ALTERADO",{evento:"STATUS_ALTERADO",timestamp:new Date().toISOString(),lead:this.formatLeadData(e,"STATUS_ALTERADO"),mudanca:{campo:"status",valorAnterior:t,valorNovo:a}})})}dispatchProposalValueChanged(e,t,a){return s(this,null,function*(){yield this.dispatchWebhooks("VALOR_PROPOSTA_ALTERADO",{evento:"VALOR_PROPOSTA_ALTERADO",timestamp:new Date().toISOString(),lead:this.formatLeadData(e,"VALOR_PROPOSTA_ALTERADO"),mudanca:{campo:"valorContrato",valorAnterior:t,valorNovo:a}})})}dispatchLeadCreated(e){return s(this,null,function*(){yield this.dispatchWebhooks("LEAD_CRIADO",{evento:"LEAD_CRIADO",timestamp:new Date().toISOString(),lead:this.formatLeadData(e,"LEAD_CRIADO")})})}dispatchLeadUpdated(e){return s(this,null,function*(){yield this.dispatchWebhooks("LEAD_ATUALIZADO",{evento:"LEAD_ATUALIZADO",timestamp:new Date().toISOString(),lead:this.formatLeadData(e,"LEAD_ATUALIZADO")})})}dispatchLeadDeleted(e){return s(this,null,function*(){yield this.dispatchWebhooks("LEAD_DELETADO",{evento:"LEAD_DELETADO",timestamp:new Date().toISOString(),lead:this.formatLeadData(e,"LEAD_DELETADO")})})}dispatchInteractionCreated(e,t){return s(this,null,function*(){yield this.dispatchWebhooks("INTERACAO_CRIADA",{evento:"INTERACAO_CRIADA",timestamp:new Date().toISOString(),lead:this.formatLeadData(t,"INTERACAO_CRIADA"),interacao:{id:e.id,tipo:e.tipo,conteudo:e.conteudo,dataCriacao:e.dataCriacao,usuarioCriacao:e.usuarioCriacao}})})}dispatchWebhooks(e,t){return s(this,null,function*(){try{let a=yield this.databaseService.getWebhooks().toPromise();if(!a)return;let r=a.filter(o=>o.ativo&&o.eventos.includes(e));for(let o of r)yield this.sendWebhook(o,e,t)}catch(a){console.error("Erro ao disparar webhooks:",a)}})}sendWebhook(e,t,a){return s(this,null,function*(){try{let r=this.filterPayloadByWebhookConfig(e,t,a),o=yield fetch(e.url,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":"LeadPro-Webhook/1.0","X-Webhook-Event":t,"X-Webhook-Source":"LeadPro"},body:JSON.stringify(r)});o.ok?console.log(`Webhook ${e.nome} enviado com sucesso para evento ${t}`):console.warn(`Webhook ${e.nome} falhou: ${o.status} ${o.statusText}`)}catch(r){console.error(`Erro ao enviar webhook ${e.nome}:`,r)}})}filterPayloadByWebhookConfig(e,t,a){let r=e.configuracaoEventos?.find(c=>c.evento===t);if(!r)return{evento:a.evento,timestamp:a.timestamp,webhook:{id:e.id,nome:e.nome}};let o={};r.dadosEnviados&&r.dadosEnviados.forEach(c=>{c.ativo&&a.lead&&a.lead[c.campo]!==void 0&&(o[c.campo]=a.lead[c.campo])});let d={evento:a.evento,timestamp:a.timestamp,webhook:{id:e.id,nome:e.nome}};return Object.keys(o).length>0&&(d.lead=o),a.mudanca&&(d.mudanca=a.mudanca),a.interacao&&(d.interacao=a.interacao),d}formatLeadData(e,t){let a={id:e.id,nome:e.nome,email:e.email,telefone:e.telefone,empresa:e.empresa,cargo:e.cargo,fonte:e.fonte,status:e.status,valorContrato:e.valorContrato,observacoes:e.observacoes,dataCriacao:e.dataCriacao,dataAtualizacao:e.dataAtualizacao,usuarioCriacao:e.usuarioCriacao,usuarioAtualizacao:e.usuarioAtualizacao};return Object.keys(a).forEach(r=>{a[r]===void 0&&delete a[r]}),a}static \u0275fac=function(t){return new(t||n)(u(m))};static \u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"})};var S=class n{constructor(e,t,a){this.databaseService=e;this.authService=t;this.webhookDispatcher=a;this.loadLeads()}leadsSubject=new A([]);leads$=this.leadsSubject.asObservable();loadLeads(){this.databaseService.getLeads().subscribe({next:e=>this.leadsSubject.next(e),error:e=>console.error("Erro ao carregar leads:",e)})}getLeads(){return this.leads$}getLead(e){return this.databaseService.getLead(e)}createLead(e){let t=L(p({},e),{status:"NOVO_LEAD",dataCriacao:new Date,dataAtualizacao:new Date,usuarioCriacao:this.authService.getCurrentUser()?.nome||"Sistema"});return this.databaseService.createLead(t).pipe(i(a=>(this.loadLeads(),this.webhookDispatcher.dispatchLeadCreated(a),a)))}updateLead(e,t){let a=L(p({},t),{dataAtualizacao:new Date,usuarioAtualizacao:this.authService.getCurrentUser()?.nome||"Sistema"});return this.databaseService.updateLead(e,a).pipe(i(r=>(this.loadLeads(),this.webhookDispatcher.dispatchLeadUpdated(r),r)))}updateLeadStatus(e,t){return this.databaseService.getLead(e).pipe(i(a=>{let r=a.status;return this.updateLead(e,{status:t}).subscribe(o=>{this.webhookDispatcher.dispatchStatusChanged(o,r,t)}),a}))}deleteLead(e){return this.databaseService.deleteLead(e).pipe(i(()=>{this.loadLeads()}))}qualifyLead(e,t){let a=t?"LEAD_QUALIFICADO":"LEAD_NAO_QUALIFICADO";return this.updateLeadStatus(e,a)}assessInterest(e,t){let a=t?"INTERESSE":"NAO_TEVE_INTERESSE";return this.updateLeadStatus(e,a)}schedulePresentation(e,t){let a=t?"APRESENTACAO_AGENDADA":"NAO_FOI_POSSIVEL_AGENDAR";return this.updateLeadStatus(e,a)}sendProposal(e){return this.updateLeadStatus(e,"PROPOSTA_ENVIADA")}handleProposalResponse(e,t){let a=t?"PROPOSTA_ACEITA":"PROPOSTA_NEGADA";return this.updateLeadStatus(e,a)}requestData(e){return this.updateLeadStatus(e,"AGUARDANDO_DADOS")}confirmDataReceived(e){return this.updateLeadStatus(e,"DADOS_ENVIADOS")}createGroup(e){return this.updateLeadStatus(e,"GRUPO_CRIADO")}confirmGroupEntry(e,t){let a=t?"CLIENTE_ENTROU_GRUPO":"CLIENTE_NAO_ENTROU_GRUPO";return this.updateLeadStatus(e,a)}requestVMs(e){return this.updateLeadStatus(e,"AGUARDANDO_VMS")}confirmVMsReceived(e){return this.updateLeadStatus(e,"VMS_ENVIADAS")}startActivation(e){return this.updateLeadStatus(e,"ATIVACAO_INICIADA")}markAsImplemented(e){return this.updateLeadStatus(e,"IMPLANTADO")}registerInSGP(e){return this.updateLeadStatus(e,"CADASTRADO_SGP")}markAsBilled(e){return this.updateLeadStatus(e,"FATURADO")}storeForFuture(e){return this.updateLeadStatus(e,"ARMAZENADO_FUTURO")}setToFollowUp(e){return this.updateLeadStatus(e,"COBRAR")}getInteractions(e){return this.databaseService.getInteractions(e)}createInteraction(e,t,a){let r={lead_id:e,tipo:t,conteudo:a,usuario_criacao:this.authService.getCurrentUser()?.nome||"Sistema"};return this.databaseService.createInteraction(r).pipe(i(o=>(this.databaseService.getLead(e).subscribe(d=>{this.webhookDispatcher.dispatchInteractionCreated(o,d)}),o)))}filterLeadsByStatus(e){return this.leads$.pipe(i(t=>t.filter(a=>a.status===e)))}filterLeadsBySource(e){return this.leads$.pipe(i(t=>t.filter(a=>a.fonte===e)))}searchLeads(e){let t=e.toLowerCase();return this.leads$.pipe(i(a=>a.filter(r=>r.nome.toLowerCase().includes(t)||r.email.toLowerCase().includes(t)||r.telefone.includes(e)||r.empresa?.toLowerCase().includes(t))))}getStats(){return this.databaseService.getDashboardStats()}generateWhatsAppMessage(e){let t=`Ol\xE1 ${e.nome}! 

Sou da equipe LeadPro e gostaria de conversar sobre como podemos ajudar sua empresa.

Voc\xEA poderia me informar um hor\xE1rio que seja conveniente para uma breve conversa?

Aguardo seu retorno!

Atenciosamente,
Equipe LeadPro`;return encodeURIComponent(t)}openWhatsApp(e){let t=this.generateWhatsAppMessage(e),r=`https://wa.me/55${e.telefone.replace(/\D/g,"")}?text=${t}`;window.open(r,"_blank")}static \u0275fac=function(t){return new(t||n)(u(m),u(v),u(h))};static \u0275prov=b({token:n,factory:n.\u0275fac,providedIn:"root"})};export{S as a};
