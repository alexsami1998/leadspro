import{a as S}from"./chunk-JOMA7PJZ.js";import{$b as r,O as m,S as p,Yb as o,a as L,b as D,bc as O,d as c,k as l,r as d}from"./chunk-G7TP3EBD.js";var f=(()=>{let n=class n{constructor(e){this.databaseService=e}dispatchStatusChanged(e,a,t){return c(this,null,function*(){yield this.dispatchWebhooks(r.STATUS_ALTERADO,{evento:r.STATUS_ALTERADO,timestamp:new Date().toISOString(),lead:this.formatLeadData(e,r.STATUS_ALTERADO),mudanca:{campo:"status",valorAnterior:a,valorNovo:t}})})}dispatchProposalValueChanged(e,a,t){return c(this,null,function*(){yield this.dispatchWebhooks(r.VALOR_PROPOSTA_ALTERADO,{evento:r.VALOR_PROPOSTA_ALTERADO,timestamp:new Date().toISOString(),lead:this.formatLeadData(e,r.VALOR_PROPOSTA_ALTERADO),mudanca:{campo:"valorContrato",valorAnterior:a,valorNovo:t}})})}dispatchLeadCreated(e){return c(this,null,function*(){yield this.dispatchWebhooks(r.LEAD_CRIADO,{evento:r.LEAD_CRIADO,timestamp:new Date().toISOString(),lead:this.formatLeadData(e,r.LEAD_CRIADO)})})}dispatchLeadUpdated(e){return c(this,null,function*(){yield this.dispatchWebhooks(r.LEAD_ATUALIZADO,{evento:r.LEAD_ATUALIZADO,timestamp:new Date().toISOString(),lead:this.formatLeadData(e,r.LEAD_ATUALIZADO)})})}dispatchLeadDeleted(e){return c(this,null,function*(){yield this.dispatchWebhooks(r.LEAD_DELETADO,{evento:r.LEAD_DELETADO,timestamp:new Date().toISOString(),lead:this.formatLeadData(e,r.LEAD_DELETADO)})})}dispatchInteractionCreated(e,a){return c(this,null,function*(){yield this.dispatchWebhooks(r.INTERACAO_CRIADA,{evento:r.INTERACAO_CRIADA,timestamp:new Date().toISOString(),lead:this.formatLeadData(a,r.INTERACAO_CRIADA),interacao:{id:e.id,tipo:e.tipo,conteudo:e.conteudo,dataCriacao:e.dataCriacao,usuarioCriacao:e.usuarioCriacao}})})}dispatchWebhooks(e,a){return c(this,null,function*(){try{let t=yield this.databaseService.getWebhooks().toPromise();if(!t)return;let s=t.filter(i=>i.ativo&&i.eventos.includes(e));for(let i of s)yield this.sendWebhook(i,e,a)}catch(t){console.error("Erro ao disparar webhooks:",t)}})}sendWebhook(e,a,t){return c(this,null,function*(){try{let s=this.filterPayloadByWebhookConfig(e,a,t),i=yield fetch(e.url,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":"LeadPro-Webhook/1.0","X-Webhook-Event":a,"X-Webhook-Source":"LeadPro"},body:JSON.stringify(s)});i.ok?console.log(`Webhook ${e.nome} enviado com sucesso para evento ${a}`):console.warn(`Webhook ${e.nome} falhou: ${i.status} ${i.statusText}`)}catch(s){console.error(`Erro ao enviar webhook ${e.nome}:`,s)}})}filterPayloadByWebhookConfig(e,a,t){let s=e.configuracaoEventos?.find(A=>A.evento===a);if(!s)return{evento:t.evento,timestamp:t.timestamp,webhook:{id:e.id,nome:e.nome}};let i={};s.dadosEnviados&&s.dadosEnviados.forEach(A=>{A.ativo&&t.lead&&t.lead[A.campo]!==void 0&&(i[A.campo]=t.lead[A.campo])});let h={evento:t.evento,timestamp:t.timestamp,webhook:{id:e.id,nome:e.nome}};return Object.keys(i).length>0&&(h.lead=i),t.mudanca&&(h.mudanca=t.mudanca),t.interacao&&(h.interacao=t.interacao),h}formatLeadData(e,a){let t={id:e.id,nome:e.nome,email:e.email,telefone:e.telefone,empresa:e.empresa,cargo:e.cargo,fonte:e.fonte,status:e.status,valorContrato:e.valorContrato,observacoes:e.observacoes,dataCriacao:e.dataCriacao,dataAtualizacao:e.dataAtualizacao,usuarioCriacao:e.usuarioCriacao,usuarioAtualizacao:e.usuarioAtualizacao};return Object.keys(t).forEach(s=>{t[s]===void 0&&delete t[s]}),t}};n.\u0275fac=function(a){return new(a||n)(p(S))},n.\u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"});let u=n;return u})();var w=(()=>{let n=class n{constructor(e,a,t){this.databaseService=e,this.authService=a,this.webhookDispatcher=t,this.leadsSubject=new l([]),this.leads$=this.leadsSubject.asObservable(),this.loadLeads()}loadLeads(){this.databaseService.getLeads().subscribe({next:e=>this.leadsSubject.next(e),error:e=>console.error("Erro ao carregar leads:",e)})}getLeads(){return this.leads$}getLead(e){return this.databaseService.getLead(e)}createLead(e){let a=D(L({},e),{status:o.NOVO_LEAD,dataCriacao:new Date,dataAtualizacao:new Date,usuarioCriacao:this.authService.getCurrentUser()?.nome||"Sistema"});return this.databaseService.createLead(a).pipe(d(t=>(this.loadLeads(),this.webhookDispatcher.dispatchLeadCreated(t),t)))}updateLead(e,a){let t=D(L({},a),{dataAtualizacao:new Date,usuarioAtualizacao:this.authService.getCurrentUser()?.nome||"Sistema"});return this.databaseService.updateLead(e,t).pipe(d(s=>(this.loadLeads(),this.webhookDispatcher.dispatchLeadUpdated(s),s)))}updateLeadStatus(e,a){return this.databaseService.getLead(e).pipe(d(t=>{let s=t.status;return this.updateLead(e,{status:a}).subscribe(i=>{this.webhookDispatcher.dispatchStatusChanged(i,s,a)}),t}))}deleteLead(e){return this.databaseService.deleteLead(e).pipe(d(()=>{this.loadLeads()}))}qualifyLead(e,a){let t=a?o.LEAD_QUALIFICADO:o.LEAD_NAO_QUALIFICADO;return this.updateLeadStatus(e,t)}assessInterest(e,a){let t=a?o.INTERESSE:o.NAO_TEVE_INTERESSE;return this.updateLeadStatus(e,t)}schedulePresentation(e,a){let t=a?o.APRESENTACAO_AGENDADA:o.NAO_FOI_POSSIVEL_AGENDAR;return this.updateLeadStatus(e,t)}sendProposal(e){return this.updateLeadStatus(e,o.PROPOSTA_ENVIADA)}handleProposalResponse(e,a){let t=a?o.PROPOSTA_ACEITA:o.PROPOSTA_NEGADA;return this.updateLeadStatus(e,t)}requestData(e){return this.updateLeadStatus(e,o.AGUARDANDO_DADOS)}confirmDataReceived(e){return this.updateLeadStatus(e,o.DADOS_ENVIADOS)}createGroup(e){return this.updateLeadStatus(e,o.GRUPO_CRIADO)}confirmGroupEntry(e,a){let t=a?o.CLIENTE_ENTROU_GRUPO:o.CLIENTE_NAO_ENTROU_GRUPO;return this.updateLeadStatus(e,t)}requestVMs(e){return this.updateLeadStatus(e,o.AGUARDANDO_VMS)}confirmVMsReceived(e){return this.updateLeadStatus(e,o.VMS_ENVIADAS)}startActivation(e){return this.updateLeadStatus(e,o.ATIVACAO_INICIADA)}markAsImplemented(e){return this.updateLeadStatus(e,o.IMPLANTADO)}registerInSGP(e){return this.updateLeadStatus(e,o.CADASTRADO_SGP)}markAsBilled(e){return this.updateLeadStatus(e,o.FATURADO)}storeForFuture(e){return this.updateLeadStatus(e,o.ARMAZENADO_FUTURO)}setToFollowUp(e){return this.updateLeadStatus(e,o.COBRAR)}getInteractions(e){return this.databaseService.getInteractions(e)}createInteraction(e,a,t){let s={lead_id:e,tipo:a,conteudo:t,usuario_criacao:this.authService.getCurrentUser()?.nome||"Sistema"};return this.databaseService.createInteraction(s).pipe(d(i=>(this.databaseService.getLead(e).subscribe(h=>{this.webhookDispatcher.dispatchInteractionCreated(i,h)}),i)))}filterLeadsByStatus(e){return this.leads$.pipe(d(a=>a.filter(t=>t.status===e)))}filterLeadsBySource(e){return this.leads$.pipe(d(a=>a.filter(t=>t.fonte===e)))}searchLeads(e){let a=e.toLowerCase();return this.leads$.pipe(d(t=>t.filter(s=>s.nome.toLowerCase().includes(a)||s.email.toLowerCase().includes(a)||s.telefone.includes(e)||s.empresa?.toLowerCase().includes(a))))}getStats(){return this.databaseService.getDashboardStats()}generateWhatsAppMessage(e){let a=`Ol\xE1 ${e.nome}! 

Sou da equipe LeadPro e gostaria de conversar sobre como podemos ajudar sua empresa.

Voc\xEA poderia me informar um hor\xE1rio que seja conveniente para uma breve conversa?

Aguardo seu retorno!

Atenciosamente,
Equipe LeadPro`;return encodeURIComponent(a)}openWhatsApp(e){let a=this.generateWhatsAppMessage(e),s=`https://wa.me/55${e.telefone.replace(/\D/g,"")}?text=${a}`;window.open(s,"_blank")}};n.\u0275fac=function(a){return new(a||n)(p(S),p(O),p(f))},n.\u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"});let u=n;return u})();export{w as a};
